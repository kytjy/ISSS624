---
title: "Take-home Exercise 2: Applied Spatial Interaction Models: A case study of Singapore public bus commuter flows"
date: "07 December 2023"
date-modified: "last-modified"
editor: visual
execute:
  freeze: auto
  echo: true #all the codes will appear
  eval: true #all the codes will run
  warning: false #dont display if there are any warnings
format: 
  html:
    code-fold: false
    code-overflow: scroll
    code-summary: "Show the code"
    code-line-numbers: true
---

# 1 Overview

## 1.1 Background

## 1.2 Objectives

::: panel-tabset
## Aim

## Tasks

The specific tasks of this take-home exercise are as follows:

### **Geospatial Data Science**

-   Derive an analytical hexagon data of 325m (this distance is the perpendicular distance between the centre of the hexagon and its edges) to represent the [traffic analysis zone (TAZ)](https://tmg.utoronto.ca/files/Reports/Traffic-Zone-Guidance_March-2021_Final.pdf).

-   With reference to the time intervals provided in the table below, construct an O-D matrix of commuter flows for a time interval of your choice by integrating *Passenger Volume by Origin Destination Bus Stops* and *Bus Stop Location* from [LTA DataMall](https://datamall.lta.gov.sg/content/datamall/en.html). The O-D matrix must be aggregated at the analytics hexagon level

    | Peak hour period             | Bus tap on time |
    |------------------------------|-----------------|
    | Weekday morning peak         | 6am to 9am      |
    | Weekday afternoon peak       | 5pm to 8pm      |
    | Weekend/holiday morning peak | 11am to 2pm     |
    | Weekend/holiday evening peak | 4pm to 7pm      |

-   Display the O-D flows of the passenger trips by using appropriate geovisualisation methods (not more than 5 maps).

-   Describe the spatial patterns revealed by the geovisualisation (not more than 100 words per visual).

-   Assemble at least three propulsive and three attractiveness variables by using aspatial and geospatial from publicly available sources.

-   Compute a distance matrix by using the analytical hexagon data derived earlier.

### **Spatial Interaction Modelling**

-   Calibrate spatial interactive models to determine factors affecting urban commuting flows at the selected time interval.

-   Present the modelling results by using appropriate geovisualisation and graphical visualisation methods. (Not more than 5 visuals)

-   With reference to the Spatial Interaction Model output tables, maps and data visualisation prepared, describe the modelling results. (not more than 100 words per visual).
:::

# 2 Loading Packages

::: panel-tabset
## Packages

The following packages will be used for this exercise:

+-----------------------------------------------------------------------------------------+--------------------------------------------------------------------------+
| Package                                                                                 | Description                                                              |
+=========================================================================================+==========================================================================+
| [**tmap**](https://cran.r-project.org/web/packages/tmap/vignettes/tmap-getstarted.html) | For thematic mapping                                                     |
+-----------------------------------------------------------------------------------------+--------------------------------------------------------------------------+
| [**sf**](https://r-spatial.github.io/sf/) & [**sp**]()                                  | For importing, integrating, processing, and transforming geospatial data |
+-----------------------------------------------------------------------------------------+--------------------------------------------------------------------------+
| [**tidyverse**](https://www.tidyverse.org/)                                             | For non-spatial data wrangling                                           |
+-----------------------------------------------------------------------------------------+--------------------------------------------------------------------------+
| [**knitr**](https://cran.r-project.org/web/packages/knitr/)                             | For dynamic report generation                                            |
+-----------------------------------------------------------------------------------------+--------------------------------------------------------------------------+
| [**scales**](https://scales.r-lib.org/)                                                 | For scaling graphs                                                       |
+-----------------------------------------------------------------------------------------+--------------------------------------------------------------------------+

## Code

```{r}
pacman::p_load(tmap, sf, sp, 
               tidyverse, DT, performance, 
               reshape2, ggpubr)
```
:::

# 3 Data Preparation

For the purpose of this assignment, the following data will be used:

+---+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+--------+----------------------------------------------------------------------------------------------------------+
|   | Type       | Name                                                                                                                                                                                                                                   | As of Date | Format | Source                                                                                                   |
+===+============+========================================================================================================================================================================================================================================+============+========+==========================================================================================================+
| 1 | Aspatial   | Passenger Volume by Origin Destination Bus Stops                                                                                                                                                                                       | Oct 2023   | .csv   | [LTA DataMall](https://datamall.lta.gov.sg/content/datamall/en/dynamic-data.html)                        |
+---+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+--------+----------------------------------------------------------------------------------------------------------+
| 2 | Aspatial   | School Directory and Information (General information of schools)                                                                                                                                                                      | Mar 2022   | .csv   | [Data.gov.sg](https://beta.data.gov.sg/collections/457/datasets/d_688b934f82c1059ed0a6993d2a829089/view) |
+---+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+--------+----------------------------------------------------------------------------------------------------------+
| 3 | Aspatial   | HDB Property Information (Geocoded)                                                                                                                                                                                                    | Sep 2021   | .csv   | Courtesy of Prof T. S. Kam                                                                               |
+---+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+--------+----------------------------------------------------------------------------------------------------------+
| 4 | Geospatial | Bus Stop Location                                                                                                                                                                                                                      | Jul 2023   | .shp   | [LTA DataMall](https://datamall.lta.gov.sg/content/datamall/en/static-data.html)                         |
+---+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+--------+----------------------------------------------------------------------------------------------------------+
| 5 | Geospatial | Train Station                                                                                                                                                                                                                          | Feb 2023   | .shp   | [LTA DataMall](https://datamall.lta.gov.sg/content/datamall/en/static-data.html)                         |
+---+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+--------+----------------------------------------------------------------------------------------------------------+
| 6 | Geospatial | Train Station Exit Point                                                                                                                                                                                                               | Aug 2023   | .shp   | [LTA DataMall](https://datamall.lta.gov.sg/content/datamall/en/static-data.html)                         |
+---+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+--------+----------------------------------------------------------------------------------------------------------+
| 7 | Geospatial | Master Plan 2019 Subzone Boundary                                                                                                                                                                                                      | 2019       | .shp   | Courtesy of Prof T.S. Kam                                                                                |
+---+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+--------+----------------------------------------------------------------------------------------------------------+
| 8 | Geospatial | Business, entertn, F&B, FinServ, Leisure&Recreation and Retails                                                                                                                                                                        |            | .shp   | Courtesy of Prof T.S. Kam                                                                                |
|   |            |                                                                                                                                                                                                                                        |            |        |                                                                                                          |
|   |            | (Geospatial data sets of the locations of business establishments, entertainments, food and beverage outlets, financial centres, leisure and recreation centres, retail and services stores/outlets compiled for urban mobility study) |            |        |                                                                                                          |
+---+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+--------+----------------------------------------------------------------------------------------------------------+

## 3.1 OD Data

::: panel-tabset
## Importing csv

*Passenger Volume by Origin Destination Bus Stops* dataset for October 2023, downloaded from LTA DataMall by using read_csv() or readr package.

```{r}
odbus <- read_csv("data/aspatial/origin_destination_bus_202310.csv")
```

## Attributes

*glimpse()* of the **dplyr** package allows us to see all columns and their data type in the data frame.

```{r}
glimpse(odbus)
```

**Observations:**

-   There are 7 variables in the odbus tibble data, they are:
    -   YEAR_MONTH: Month in which data is collected
    -   DAY_TYPE: Weekdays or weekends/holidays
    -   TIME_PER_HOUR: Hour which the passenger trip is based on, in intervals from 0 to 23 hours
    -   PT_TYPE: Type of public transport, i.e. bus
    -   ORIGIN_PT_CODE: Origin bus stop ID
    -   DESTINATION_PT_CODE: Destination bus stop ID
-   TOTAL_TRIPS: Number of trips We also note that values in ORIGIN_PT_CODE and DESTINATON_PT_CODE are in numeric data type. These should be in factor data type for further processing and georeferencing.

*as.factor()* can be used to convert the variables ORIGIN_PT_CODE and DESTINATON_PT_CODE from numeric to categorical data type. We use glimpse() again to check the results.

```{r}
odbus$ORIGIN_PT_CODE <- as.factor(odbus$ORIGIN_PT_CODE)
odbus$DESTINATION_PT_CODE <- as.factor(odbus$DESTINATION_PT_CODE)

glimpse(odbus)
```

Note that both of them are in factor data type now.

## Extracting Study Data

In our study, we would like to know study the 4 peak hour periods identified. Therefore, we can create a new variable `period` using the *ifelse()* that states whether an observation occurred during peak period using the code chunk below.

```{r}
peak <- odbus %>%
  # Weekday morning peak
  mutate(period= ifelse(DAY_TYPE=="WEEKDAY" & (TIME_PER_HOUR >= 6 & TIME_PER_HOUR <= 9), "WDM", 
                        # Weekday afternoon peak
                        ifelse(DAY_TYPE=="WEEKDAY" & (TIME_PER_HOUR >= 17 & TIME_PER_HOUR <= 20), "WDA", 
                               # Weekend/holiday morning peak
                               ifelse(DAY_TYPE=="WEEKENDS/HOLIDAY" & (TIME_PER_HOUR >= 11 & TIME_PER_HOUR <= 14), "WEM",
                                      # Weekend/holiday evening peak
                                      ifelse(DAY_TYPE=="WEEKENDS/HOLIDAY" & (TIME_PER_HOUR >= 16 & TIME_PER_HOUR <= 19), "WEE",
                                             # Return off-peak if neither of the peak hour periods
                                             "Off-peak"))))) %>% 
  select(5:8) %>% 
  # filter helps to keep records that occurred during period periods
  filter(period !="Off-peak") %>% 
  # aggregate the total passenger trips for each origin bus stop
  group_by(ORIGIN_PT_CODE, DESTINATION_PT_CODE, period) %>% 
  summarise(TRIPS=sum(TOTAL_TRIPS))
```


:::
